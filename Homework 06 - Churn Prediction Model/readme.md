<h1>Churn Prediction Model</h1>

<img src="https://github.com/suthasinee-p/BADS7105-CRM-Analytics/blob/main/Homework%2006%20-%20Churn%20Prediction%20Model/Ch1.JPG">

<code>
SELECT SHOP_DATE , TYPE_CUSTOMER ,COUNT(1) AS NUM_TYPE
FROM (
with src as (

	SELECT SHOP_DATE , LAST_SH_DT , CUST_CODE
	FROM 
	(
		 SELECT SHOP_DATE 
		,LAST_DAY(CAST(CONCAT(CONCAT(SUBSTRING(CAST(SHOP_DATE AS STRING),1,4) ,'-')
		,CONCAT(SUBSTRING(CAST(SHOP_DATE AS STRING),5,2),'-')
		,SUBSTRING(CAST(SHOP_DATE AS STRING),7,2) ) AS DATE)) AS LAST_SH_DT
		,CUST_CODE 
		FROM `my-project-nida.Supermarket_Data.Supermarket_Data`
		where CUST_CODE is not null
	) AS X 
	GROUP BY SHOP_DATE , LAST_SH_DT , CUST_CODE
)
select  S.SHOP_DATE , 
		S.CUST_CODE,
		CASE WHEN N.CUST_CODE IS NOT NULL AND NEW_CUST.CUST_CODE IS NOT NULL THEN 'NEW CUSTOMET'
			 WHEN N.CUST_CODE IS NOT NULL AND P.CUST_CODE IS NOT NULL THEN 'REPEAT CUSTMER'
			 WHEN N.CUST_CODE IS NOT NULL AND P.CUST_CODE IS NULL AND OLD_CUST.CUST_CODE IS NOT NULL THEN 'REACTIVATED CUSTOMER'
			 ELSE 'CHURN CUSTOMET'
			 END AS TYPE_CUSTOMER
from src s
LEFT join src as p on s.CUST_CODE = p.CUST_CODE and DATE_SUB(DATE_TRUNC(s.LAST_SH_DT, MONTH), INTERVAL 1 DAY) = p.LAST_SH_DT
LEFT join src as n on s.CUST_CODE = n.CUST_CODE and S.LAST_SH_DT = n.LAST_SH_DT
LEFT join (
			SELECT COUNT(1) , CUST_CODE
			FROM src
			GROUP BY CUST_CODE
			HAVING COUNT(1) = 1 
		  ) AS NEW_CUST ON S.CUST_CODE = NEW_CUST.CUST_CODE
LEFT join (
			SELECT COUNT(1) , CUST_CODE
			FROM src
			GROUP BY CUST_CODE
			HAVING COUNT(1) > 1 
		  ) AS OLD_CUST ON S.CUST_CODE = OLD_CUST.CUST_CODE
		  
	) AS Y 
	GROUP BY SHOP_DATE , TYPE_CUSTOMER 
	ORDER BY SHOP_DATE
</code>
